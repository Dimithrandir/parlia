(function(root,factory){if(typeof define==="function"&&define.amd){define(factory)}else if(typeof module==="object"&&module.exports){module.exports=factory()}else{root.Parlia=factory()}})(typeof self!=="undefined"?self:this,function(){"use strict";const SVGNS="http://www.w3.org/2000/svg";const SVG_COMMENT="\x3c!-- Created with parlia --\x3e";const SVG_HEADER='<?xml version="1.0" encoding="UTF-8" standalone="no"?>';const SVG_NAME="parliament.svg";const CSV_HEADER="id,color,name,seats";const CSV_NAME="parties.csv";const DEFAULTS={rInner:5,rDenom:2.5,sortField:0,sortOrder:0,border:true,shadow:true,background:"#f2f2f2",padding:12,centralAngle:180};var selectedParties=new Set;var nParties=0;var Parlia={};Parlia.DEFAULTS=DEFAULTS;Parlia.drawParliament=drawParliament;Parlia.drawError=drawError;Parlia.selectedParties=selectedParties;Parlia.downloadParliament=downloadParliament;Parlia.parseFromCsv=parseFromCsv;Parlia.parseToCsv=parseToCsv;function drawParliament(svg,data,rInner=DEFAULTS.rInner,rDenom=DEFAULTS.rDenom,sortField=DEFAULTS.sortField,sortOrder=DEFAULTS.sortOrder,border=DEFAULTS.border,shadow=DEFAULTS.shadow,background=DEFAULTS.background,padding=DEFAULTS.padding,centralAngle=DEFAULTS.centralAngle){let parties=parseData(data);centralAngle=toRadians(Math.min(centralAngle,180));svg.innerHTML="";selectedParties.clear();nParties=parties.length;let svgRect=svg.getBoundingClientRect();let backRect={};backRect.width=svgRect.width;backRect.height=svgRect.height;backRect.left=0;backRect.top=0;let parlRect={width:svgRect.width,height:svgRect.height};let svgRectRatio=svgRect.width/svgRect.height;if(svgRectRatio>2){parlRect.width=svgRect.height*2;parlRect.height=svgRect.height}else if(svgRectRatio<2){parlRect.width=svgRect.width;parlRect.height=svgRect.width/2}parlRect.width-=2*padding;parlRect.height-=padding;parlRect.left=(svgRect.width-parlRect.width)/2;parlRect.top=(svgRect.height-parlRect.height)/2;parlRect.area=parlRect.width*parlRect.height;let parlSemi={};parlSemi.r1=parlRect.width/rInner;parlSemi.r2=parlRect.width/2;parlSemi.t=parlSemi.r2-parlSemi.r1;parlSemi.area=centralAngle*(parlSemi.r2-parlSemi.r1)*(parlSemi.r2+parlSemi.r1)/2;let nSeats=0;parties.forEach(item=>nSeats+=item.seats);let square={};square.area=parlSemi.area/nSeats;square.a=Math.sqrt(square.area);let seat={};seat.r=square.a/rDenom;let rows=[];let nRows=Math.floor(parlSemi.t/(2*seat.r));for(let i=1;i<=nRows;i++){let row={};row.marginRad=(parlSemi.t-nRows*(2*seat.r))/(2*nRows);row.r=parlSemi.r1+(seat.r+row.marginRad)*(2*i-1);row.l=row.r*centralAngle;row.theta=Math.asin(seat.r/row.r);seat.arc=2*row.theta*row.r;row.kSeats=Math.floor(row.l/seat.arc);row.marginCirc=(row.l-row.kSeats*seat.arc)/(row.kSeats-1);row.beta=row.marginCirc/row.r;rows.push(row)}if(rows.length==0){return{seatsTotal:nSeats,seatsDrawn:0}}while(true){let sum=0;for(let row of rows){sum+=row.kSeats}if(sum<=nSeats){break}let min=rows[0].marginCirc;let minIndex=0;for(let i=1;i<rows.length;i++){if(rows[i].marginCirc<min){min=rows[i].marginCirc;minIndex=i}}rows[minIndex].kSeats--;rows[minIndex].marginCirc=(rows[minIndex].l-rows[minIndex].kSeats*seat.arc)/(rows[minIndex].kSeats-1);rows[minIndex].beta=rows[minIndex].marginCirc/rows[minIndex].r}let topRowSeats=rows[nRows-1].kSeats;let seatMatrix=Array.from({length:nRows},(v,i)=>Array.from({length:topRowSeats},(v,j)=>{let curRowSeats=rows[i].kSeats;let seatDiff=(topRowSeats-curRowSeats)/2;return j<Math.ceil(seatDiff)||j>topRowSeats-1-Math.floor(seatDiff)?-1:0}));switch(sortField){case 0:parties=parties.sort((a,b)=>a.id-b.id);break;case 1:parties=parties.sort((a,b)=>a.seats-b.seats);break;case 2:parties=parties.sort((a,b)=>a.name.localeCompare(b.name));break;default:break}switch(sortOrder){case 1:parties.reverse();break;case 2:if(sortField==1){parties.reverse()}parties=parties.filter((item,i)=>i%2==0).concat(parties.filter((item,i)=>i%2!=0).reverse());break;default:break}let dataIndex=0;let dataCounter=0;for(let j=0;j<topRowSeats;j++){for(let i=j%2==0?nRows-1:0;i>=0&&i<nRows;j%2==0?i--:i++){if(seatMatrix[i][j]==0){if(dataCounter>=parties[dataIndex].seats){dataIndex++;dataCounter=0}seatMatrix[i][j]=dataIndex;dataCounter++}}}for(let i=0;i<nRows;i++){seatMatrix[i]=seatMatrix[i].filter(el=>el!=-1)}let seatCounter=0;let gamma=(Math.PI-centralAngle)/2;for(let i=0;i<nRows;i++){for(let j=0,alpha=gamma+rows[i].theta;j<rows[i].kSeats;j++,alpha+=2*rows[i].theta+rows[i].beta){seat.cx=parlRect.left+parlSemi.r2-Math.cos(alpha)*rows[i].r;seat.cy=parlRect.top+parlRect.height-Math.sin(alpha)*rows[i].r;let party=parties[seatMatrix[i][j]];drawSeat(seat.cx,seat.cy,seat.r,party.color,party.name,party.id,svg,border,shadow);seatCounter++}}drawRect(backRect,svg,background);if(nSeats!=seatCounter){drawError(svg,"CAN'T FIT ALL SEATS","Try reducing the seat size")}return{seatsTotal:nSeats,seatsDrawn:seatCounter}}function drawRect(parlRect,svg,color){let rect=document.createElementNS(SVGNS,"rect");rect.setAttribute("width",parlRect.width);rect.setAttribute("height",parlRect.height);rect.setAttribute("x",parlRect.left);rect.setAttribute("y",parlRect.top);rect.setAttribute("fill",color);rect.setAttribute("class","parlRect");rect.addEventListener("click",()=>click());let title=document.createElementNS(SVGNS,"title");title.innerHTML="Parliament";rect.appendChild(title);svg.insertBefore(rect,svg.firstChild)}function drawSeat(cx,cy,r,color,name,id,svg,border,shadow){let circle=document.createElementNS(SVGNS,"circle");circle.setAttribute("cx",cx);circle.setAttribute("cy",cy);circle.setAttribute("r",r);circle.setAttribute("fill",color);circle.setAttribute("class","seat-party-"+id);if(border){circle.setAttribute("stroke","black");circle.setAttribute("stroke-width",2)}circle.addEventListener("click",()=>click(id));let title=document.createElementNS(SVGNS,"title");title.innerHTML=name;circle.appendChild(title);svg.appendChild(circle);if(shadow){let shadow=document.createElementNS(SVGNS,"circle");shadow.setAttribute("cx",cx+3);shadow.setAttribute("cy",cy+5);shadow.setAttribute("r",r);shadow.setAttribute("fill","black");shadow.setAttribute("opacity","80%");shadow.setAttribute("class","shadow-party-"+id);svg.insertBefore(shadow,svg.firstChild)}}function drawError(svg,title,subtitle){let svgRect=svg.getBoundingClientRect();let rect=document.createElementNS(SVGNS,"rect");rect.setAttribute("width",svgRect.width/2+svgRect.width/10);rect.setAttribute("height",svgRect.height/3);rect.setAttribute("x",svgRect.width/4-svgRect.width/20);rect.setAttribute("y",svgRect.height/3);rect.setAttribute("stroke","black");rect.setAttribute("stroke-width",8);rect.setAttribute("fill","white");let text1=document.createElementNS(SVGNS,"text");text1.setAttribute("x",svgRect.width/2);text1.setAttribute("y",svgRect.height/2);text1.setAttribute("fill","#000");text1.setAttribute("font-size","25");text1.style.textAnchor="middle";text1.style.fontFamily="sans-serif";text1.innerHTML=title;let text2=document.createElementNS(SVGNS,"text");text2.setAttribute("x",svgRect.width/2);text2.setAttribute("y",svgRect.height/2+svgRect.height/10);text2.setAttribute("fill","#000");text2.setAttribute("font-size","18");text2.style.textAnchor="middle";text2.style.fontFamily="sans-serif";text2.innerHTML=subtitle;svg.appendChild(rect);svg.appendChild(text1);svg.appendChild(text2)}function downloadParliament(svg){let svgCode=SVG_HEADER+"\n"+SVG_COMMENT+"\n"+svg.outerHTML;let a=document.createElement("a");a.href="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(svgCode);a.download=SVG_NAME;a.style.display="none";document.body.appendChild(a);a.click();document.body.removeChild(a)}function click(id){if(typeof id=="number"){let selectedClass="seat-party-"+id;if(selectedParties.has(selectedClass)){selectedParties.delete(selectedClass)}else{selectedParties.add("seat-party-"+id)}if(selectedParties.size==nParties){selectedParties.clear()}}else{if(selectedParties.size==0){return}selectedParties.clear()}setOpacity()}function setOpacity(){for(let seat of document.getElementsByTagName("circle")){if(selectedParties.size==0||selectedParties.has(seat.getAttribute("class").replace("shadow","seat"))){seat.setAttribute("opacity",seat.getAttribute("class").includes("shadow")?"80%":"100%")}else{seat.setAttribute("opacity",seat.getAttribute("class").includes("shadow")?"0%":"20%")}}}function toRadians(angle){return angle*(Math.PI/180)}function toDegrees(angle){return angle*(180/Math.PI)}function parseData(data){if(Array.isArray(data)&&Array.isArray(data[0])){if(data.every(item=>{return typeof item[0]==="number"&&typeof item[1]==="string"&&typeof item[2]==="string"&&typeof item[3]==="number"})){let result=[];data.forEach(item=>result.push({id:item[0],color:item[1],name:item[2],seats:item[3]}));return result}else{throw new TypeError("Party values not of expected type.")}}else if(Array.isArray(data)&&data[0]instanceof Object){if(data.every(item=>{return CSV_HEADER.split(",").every(prop=>Object.hasOwn(item,prop))&&typeof item.id==="number"&&typeof item.color==="string"&&typeof item.color==="string"&&typeof item.seats==="number"})){return data}else{throw new TypeError("Party values not of expected type.")}}else{throw new TypeError("Party values not of expected type.")}}function parseToCsv(data){let text=CSV_HEADER;data.forEach(item=>text+=`\n${item.id},${item.color},${item.name},${item.seats}`);let blob=new Blob([text],{type:"text/csv"});let a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=CSV_NAME;document.body.appendChild(a);a.click();document.body.removeChild(a)}function parseFromCsv(file){return new Promise((resolve,reject)=>{let reader=new FileReader;reader.onload=()=>{let result=[];let rows=reader.result.split("\n");if(rows[0].toLowerCase().replaceAll(" ","").split(",").every(header=>CSV_HEADER.includes(header))){rows.slice(1).forEach(row=>{let party=row.split(",");if(party.length==4&&!isNaN(parseInt(party[0]))&&!isNaN(parseInt(party[3]))){result.push({id:parseInt(party[0]),color:party[1],name:party[2],seats:parseInt(party[3])})}else if(row){reject(new Error("Invalid CSV content."))}});resolve(result)}else{reject(new Error("Invalid CSV file header."))}};reader.onError=e=>{reject(e)};reader.readAsText(file)})}return Parlia});